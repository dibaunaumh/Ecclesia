{% extends 'admin/base_site.html' %}
{% load i18n %}
{% block breadcrumbs %}<div class="breadcrumbs"><a href="/">{% trans 'Home' %}</a> &rsaquo; <a href="{{ group.get_absolute_url }}">{{ group.group.name }}{% trans "'s Home" %}</a> &rsaquo; {{ discussion.name }}</div>{% endblock %}
{% block userlinks %}<a href="/admin/password_change/">{% trans 'Change password' %}</a> / <a href="/admin/logout/">{% trans 'Log out' %}</a>{% endblock %}
{% block title %}{{ discussion.name }}{{ discussion.type.name }}{% endblock %}
{% block coltype %}diagram{% endblock %}

{% block content %}

<h2>
    {{ discussion.name }} ({{ discussion.type.name }})
</h2>
{% ifequal user_permission_type 1 %}
	<form action="/discussion-delete/{{discussion.pk}}/" method="post">
        <input type="image" onclick="if(confirm('Are you sure you want to delete this discussion?')) {this.form.submit();} else { return false; }" src="/static/icons/delete.png">Delete discussion</input>
    </form>
{% endifequal %}


<p>
	{{ discussion.description }}
</p>

<hr/>

<div id="canvasContainer"></div>
<style type="text/css">
#ui_container {float: left; width: 145px; padding-left: 15px}
#canvasContainer {position: relative; margin: 0; padding: 0; float: left}
#storysvu {margin: 0; padding: 0; border: thin solid #933}
.story {position: absolute; width: 150px; height: 100px; margin: 0; padding: 0; font-size: 12pt; font-weight: bold; overflow: hidden; border: thin solid #000; cursor: move}
.story a {display: block; float: left; padding: 10px; color: #000}
.story a:hover {color: #033; text-decoration: underline}
.dragon { border: thin solid #033;opacity:.6; -moz-opacity:.6}
.selecton { border: 2px solid #033 }
img.story {width: 150px; height: 100px}
a.member img {width: 50px; height: 50px; margin: 2px; border: 1px solid #933}
</style>
<script type="text/javascript">
//Arrow		= function(label,from,to,x1,y1,x2,y2,storiesURL){
Relation = function(config) {
	this.config = {
		label		: '',
		url			: '',
		from		: {},
		to			: {},
		dimensions	: { x1 : 0, y1 : 0, x2 : 0, y2 : 0 }
	};
	if(config != null) {
		$.extend(this.config, config);
	}
};
Relation.prototype = {
	/*draw			: function(highlight) {
		ctx.save();
		ctx.beginPath();
		ctx.lineWidth = 4;
		if(highlight){
			ctx.strokeStyle="rgb(230,130,200)";
		} else {
			ctx.strokeStyle="rgb(130,130,200)";
		}
		ctx.moveTo(this.config.dimensions.x1,this.config.dimensions.y1);
		ctx.bezierCurveTo(this.config.dimensions.x1 + (this.config.dimensions.x2-this.config.dimensions.x1)/5,this.config.dimensions.y1,this.config.dimensions.x2-(this.config.dimensions.x2-this.config.dimensions.x1)/5,this.config.dimensions.y2,this.config.dimensions.x2,this.config.dimensions.y2);
		ctx.stroke();
		drawText(this.config.label,(this.config.dimensions.x1+this.config.dimensions.x2)/2, (this.config.dimensions.y1+this.config.dimensions.y2)/2, this.config.dimensions.x2-this.config.dimensions.x1,Math.atan2(this.config.dimensions.y2-this.config.dimensions.y1,this.config.dimensions.x2-this.config.dimensions.x1));
		ctx.restore();
	},*/
	toString		: function() {
		return this.config.from.toString()+" -> "+this.config.to.toString();
	},
	getLabel		: function() {
		return this.config.label;
	},
	getDims	: function() {
		return this.config.dimensions;
	},
	isInside		: function(x,y) {
		if (! ( (x >= this.config.dimensions.x1) & (x <= this.config.dimensions.x2) & (y >= Math.min(this.config.dimensions.y1,this.config.dimensions.y2)-6) & (y <= Math.max(this.config.dimensions.y1,this.config.dimensions.y2)+6) ) ){ // check if x,y is in the bounding rectangle
			return false;
		}
		var alpha = (x - this.config.dimensions.x1) / (this.config.dimensions.x2 - this.config.dimensions.x1);
		return (Math.abs(y - (alpha * (this.config.dimensions.y2-this.config.dimensions.y1) + this.config.dimensions.y1)) <= 12);

	}
	
};

//Node = function(type,label,objId,addNew,storiesURL,index) {
Story = function(config) {
	this.config = {
		objId		: 0,
		type		: 'goal',
		label		: '',
		addNew		: false,
		url			: '',
		index		: 0,
		dimensions	: { x : 0, y : 0, w : 150, h : 100 }
	};
	if(config != null) {
		$.extend(this.config, config);
	}
};
Story.prototype = {
	/*draw		: function(highlight){
		if (highlight){
			this.ctx.strokeStyle = "rgb(180,0,0)";
		} else {
			this.ctx.strokeStyle = "rgb(0,0,0)";
		}
		if(this.addNew){
			this.ctx.fillStyle = "rgb(230,230,230)";
		} else {
			this.ctx.fillStyle = "rgb(250,250,250)";
		}
		roundedRect(this.config.dimensions.x-this.config.dimensions.w/2,this.config.dimensions.y-this.config.dimensions.h/2,this.config.dimensions.w,this.config.dimensions.h,5);
		this.ctx.fillStyle = "rgb(0,0,0)";
		drawText(this.config.label, this.config.dimensions.x-5, this.config.dimensions.y, this.config.dimensions.w, 0);      
	},*/
	getDims	: function() {
		return this.config.dimensions;
	},
	isInside		: function(x,y) { // return true if x,y is inside this node
		return (x >= this.config.dimensions.x - this.config.dimensions.w/2) & (x <= this.config.dimensions.x + this.config.dimensions.w/2) & (y >= this.config.dimensions.y - this.config.dimensions.h/2) & (y <= this.config.dimensions.y + this.config.size.h/2);
	},
	toString		: function() {
		return this.config.label;
	}
};

var i = 0;
VUController = function(options) {
	this.options = {
		width		: 800,
		height		: 500,
		alias		: 'group',
		bg_url		: '/static/img/cork_board.jpg',
		update_url	: '/common/update_coords/'
	}
	if(options != null) {
		$.extend(this.options, options);
	}
	this.options.update_url = this.options.update_url + this.options.alias;

	this.elems = [];
	this.coords = [];
	this.drag = {};
	this.ctx = null;
	this.img = new Image();
	this.img.src = this.options.bg_url;
	this.data = {
	{% for story in stories %}
		x_{{ story.pk }} : {{ story.x_pos }}, y_{{ story.pk }} : {{ story.y_pos }},
	{% endfor %}
	};
	{% for story in stories %}
	this.elems[i] = [];
	this.elems[i]['id'] = {{ story.pk }};
	this.elems[i]['name'] = '{{ story.name }}';
	this.elems[i]['url'] = '{{ story.get_absolute_url }}';
	this.coords[i++] = { left : {{ story.x_pos }}, top : {{ story.y_pos }} };
	{% endfor %}
	var this_ = this;
	$(this.img).load(function(){
		this_.init();
	});
};
VUController.prototype = {
	init		: function() {
		if(this.initCanvas()) {
			var this_ = this;
			$.each(this.elems, function(id, el) {
				$('#canvasContainer').append('<div class="'+this_.options.alias+'" id="'+this_.options.alias+'_'+id+'"><a href="'+el['url']+'">'+el['name']+'</a></div>');
				this_.drag = id;
				this_.position();
				$('#'+this_.options.alias+'_'+id).draggable({
					containment: 'parent',
					start: function(e, ui) {
						this_.setDrag(this);
						this_.grip();
					},
					stop : function(e, ui) {
						this_.coords[this_.drag] = $(this).position();
						this_.drop();
					}
				});
			});
			this.draw();
		} else {
			alert('No canvas context.');
		}
	},
	initCanvas	: function() {
		$('#canvasContainer').empty();
		$('#canvasContainer').append('<canvas id="'+this.options.alias+'svu" width="'+this.options.width+'" height="'+this.options.height+'"></canvas>');
		this.ctx = document.getElementById(this.options.alias+'svu').getContext('2d');
		return (this.ctx != null);
	},
	position	: function() {
		var w = this.coords[this.drag].left;
		var h = this.coords[this.drag].top;
		$('#'+this.options.alias+'_'+this.drag).css('left', w+'px');
		$('#'+this.options.alias+'_'+this.drag).css('top', h+'px');
	},
	setDrag		: function(el) {
		var len = this.options.alias.length + 1;
		this.drag = el.id.substr(len); // removing the this.options.alias+'_'
	},
	_draw		: function(id) {
		var h = $('#'+this.options.alias+'_'+id).height();
		var w = $('#'+this.options.alias+'_'+id).width();
		try {
			this.ctx.drawImage(this.img, this.coords[id].left, this.coords[id].top, w,  h);
		} catch(e) {}
	},
	draw		: function(isGrip) {
		var this_ = this;
		if(this.img) {
			this.ctx.clearRect(0, 0, this.options.width, this.options.height);
			$.each(this.elems, function(id, el) {
				if(isGrip) {
					if(id != this_.drag) {
						this_._draw(id);
					}
				} else {
					this_._draw(id);
				}
			});
		}
	},
	grip		: function() {
		$('#'+this.options.alias+'_'+this.drag).addClass('dragon');
		this.draw(true);
	},
	drop		: function() {
		$('#'+this.options.alias+'_'+this.drag).removeClass('dragon');
		this.draw();
		this.updateCoords();
	},
	updateCoords: function() {
		var this_ = this;
		$.each(this.elems, function(id, el){
			if(this_.coords[id].left != '') {
				var x = 'x_'+el['id'];
				var y = 'y_'+el['id'];
				this_.data[x] = parseInt(this_.coords[id].left);
				this_.data[y] = parseInt(this_.coords[id].top);
			}
		});

		$.ajax({
			type		: "POST",
			url			: this_.options.update_url,
			data		: this_.data,
			success		: function(msg){
				//alert(msg);
			}
		});
	}
};

/*
 *	A controller class that handles Discussions GUI.
 *	Accepts a VUController object instance and inherits it
 *	using jQuery.extend()
 *  ( sort of an inheritance :P )
 */
DiscussionController = function(VUController, options) {
	this.options = {};
	if(options != null) {
		$.extend(this.options, options);
	}
	this = $.extend(true, {}, VUController, this);
};
DiscussionController.prototype = {
	roundedRect	: function(x,y,width,height,radius){
		this.ctx.beginPath();
		this.ctx.moveTo(x,y+radius);
		this.ctx.lineTo(x,y+height-radius);
		this.ctx.quadraticCurveTo(x,y+height,x+radius,y+height);
		this.ctx.lineTo(x+width-radius,y+height);
		this.ctx.quadraticCurveTo(x+width,y+height,x+width,y+height-radius);
		this.ctx.lineTo(x+width,y+radius);
		this.ctx.quadraticCurveTo(x+width,y,x+width-radius,y);
		this.ctx.lineTo(x+radius,y);
		this.ctx.quadraticCurveTo(x,y,x,y+radius);
		this.ctx.fill();
		this.ctx.stroke();
    },
	drawText	: function(text,x,y,maxWidth,rotation) {
    // if text is short enough - put it in 1 line. if not, search for the middle space, and split it there (only splits to 2 lines).
        this.ctx.translate(x,y);
        this.ctx.save();
        this.ctx.rotate(rotation);        
        if (this.ctx.measureText(text).width <= maxWidth*0.8){ 
            this.ctx.fillText(text,0,0);
        } else {
            var spl = text.split('-');
            var len = Math.floor(spl.length/2);
            var pos = 0;
            for (var i=0; i<len; i++){
                pos = text.indexOf('-',pos)+1;
            }            
            var text1 = text.substring(0,pos);
            var text2 = text.substring(pos);
            this.ctx.fillText(text1,0,-10);
            this.ctx.fillText(text2,0,+10);
        }
        this.ctx.restore();
        this.ctx.translate(-x,-y);
    }
};

var config = {
	alias		: 'story',
	bg_url		: '/static/img/whiteboard.jpg'
};
var VUC = new VUController(config);
var DC	= new DiscussionController(VUC, {});
</script>

<div id="create_dialog" style="display:none" title="Create new Story">
	<form method="POST" action="" id="create_form">
	{{ story_form }}
	</form>
</div>

<div id="ui_container">
<div id="buttons_container">
{% if user_in_group %}
    <input id="create" class="ui-button ui-state-default ui-corner-all" type="button" value="{% trans 'Create Story' %}"/><br clear="all"/>
{% endif %}
	<input type="button" value="{% trans 'Stories List' %}" onclick="document.location.href='/stories_list/{{discussion.slug}}/'"/>
</div>
<hr/>
<h3>Current members</h3>
<div id="members_container">
{% for member in members %}
	<a href="{{ member.get_absolute_url }}" class="member" title="{{ member.username }}" alt=""><img src="{{ member.get_profile.get_picture_abs_url }}" alt=""/></a>
{% endfor %}
</div>
</div>

<hr/>
<!--ul>
<div id="ddd">
<input type="button" value="{% trans 'Members List' %}" onclick="document.location.href='/members_list/{{group.name}}/'"/>
{% for member in members %}
    <li><a href="{{ member.get_absolute_url }}">{{ member.username }}</a>
{% endfor %}
</div>
</ul-->

{% endblock content %}