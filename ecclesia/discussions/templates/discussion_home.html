{% extends 'admin/base_site.html' %}
{% load i18n %}
{% block breadcrumbs %}<div class="breadcrumbs"><a href="/">{% trans 'Home' %}</a> &rsaquo; <a href="{{ group.get_absolute_url }}">{{ group.group.name }}{% trans "'s Home" %}</a> &rsaquo; {{ discussion.name }}</div>{% endblock %}
{% block userlinks %}<a href="/admin/password_change/">{% trans 'Change password' %}</a> / <a href="/admin/logout/">{% trans 'Log out' %}</a>{% endblock %}
{% block title %}{{ discussion.name }} - {{ discussion.type.name }}{% endblock %}
{% block coltype %}diagram{% endblock %}
{% block extrastyle %}
    <link rel="stylesheet" type="text/css" href="/static/css/discussions.css" />
	<link rel="stylesheet" type="text/css" href="/static/js/jquery/jquery-tooltip/jquery.tooltip.css" />
{% endblock %}
{% block extrahead %}
	<script src="/static/js/jquery/jquery-tooltip/jquery.tooltip.pack.js"></script>

	<script>
        $(document).ready(function () {
            var has_voting = '{{ has_voting }}' === 'True',
                config = {
                    canvas_id	        : 'storysvu',
                    data_url	        : '/discussions/get_stories_view_json/{{ discussion.slug }}',
                    meta_url	        : '/discussions/get_visualization_meta_data/',
                    update_status_url   : '/common/presentation_status/Discussion/{{ discussion.pk }}',
                    last_changed        : '{{ last_related_update }}',
                    discussion_type     : {{ discussion.type.id }},
                    user_permissions    : '{{ user_permissions }}',
                    voting              : {
                        add_vote_url		: '{% url add_ballot discussion.pk %}'
                    }
                },
                VUC = new VUController({}),
                DC = new DiscussionController(VUC, config).init(true);
            $('button').filter('.ekkli-button').hover(
                function () {
                    $(this).addClass('ui-state-hover');
                },
                function () {
                    $(this).removeClass('ui-state-hover');
                }
            );
            $('#follow_button').click(function () {
                var $this = $(this).attr('disabled', 'disabled');
                $.ajax({
                    url : '/discussions/follow/{{ discussion.slug }}/',
                    type: 'post',
                    data: {},
                    success: function (response) {
                        if (response && response === 'success') {
                            $this.val('{% trans 'Following!' %}').fadeOut('slow');
                        } else {
                            alert("{% trans "Didn't work" %}");
                        }
                    },
                    error: function (xhr, status, error) {
                        $this.removeAttr('disabled');
                    }
                });
            });
			<!-- Create new dialog -->
			$(function() {
				var $voting_form = $("#voting_form"),
                    closeDialog = function () {
                        $voting_form.dialog('close').html('<p>{% trans 'Loading form...' %}</p>');
                    };
                $voting_form.dialog({
					bgiframe: true,
		            autoOpen: false,
					height: 400,
					width: 220,
					modal: true,
                    title: '{% trans 'Vote Details:' %}',
					buttons: {
						'Start' : function() {
							var FC = new FormController();
							FC.submit.call(FC, this, {
								callback : function () {
									closeDialog();
                                    has_voting = true;
									$('#start_vote').hide();
									$('#voting_progress').show();
								},
                                error_callback : function (response) {
                                    $voting_form.html(response);
                                }
							});
						},
						'Cancel': function() {
							closeDialog();
						}
					}
				});
				$('#start_vote').click(function() {
                    $.ajax({
                        url     : '/voting/get_voting_form',
                        success : function (html) {
                            $voting_form.html(html);
                        }
                    });
                    $voting_form.dialog('open');
                });
                $('#end_vote').click(function() {
					var that = this;
					$.ajax({
						url : '/voting/end_voting/',
						type : 'post',
						data : { 'discussion_id': {{ discussion.id }} },
						success : function () {
							$(that).hide();
							$('#voting_progress').hide();
							$('#start_vote').show();
						}
					});
				});
			});
			$( "#progressbar" ).progressbar({
				value: '{{ voting_progress_bar_value }}'
			});
        });
    </script>
{% endblock %}
{% block content %}
<div id="buttons_container">
{% if user.is_authenticated %}
	{% if not has_voting %}
    <form method="post" class="hidden" action="/voting/start_voting/{{discussion.pk}}" id="voting_form"><p>{% trans 'Loading form...' %}</p></form>
    <input type="button" class="ui-button ui-state-default ui-corner-all" id="start_vote" value="{% trans 'Start Vote' %}" />
	<div id="voting_progress" class="hidden">
		{% trans 'Voting in progress:' %}
		<div id="progressbar"></div>
        {% trans 'Time left:' %} <span id="voting_time_left"></span>
        {% trans 'Your ballots:' %}
        <span id="voting_ballots"></span>
	</div>
    <input type="button" class="hidden ui-button ui-state-default ui-corner-all" id="end_vote" value="{% trans 'End Vote' %}" />
    {% endif %}
    {% if not user_follows_discussion %}
    	<input type="button" class="ui-button ui-state-default ui-corner-all" id="follow_button" value="{% trans 'Follow' %}" />
    {% endif %}
{% endif %}
	<input type="button" class="ui-button ui-state-default ui-corner-all" value="{% trans 'Stories List' %}" onclick="document.location.href='/stories_list/{{discussion.slug}}/'" />
</div>

<h2>
    <div{% if user_in_group %} class="edit" id="discussion_{{ discussion.pk }}"{% endif %}>
		{{ discussion.name }}
	</div>
	({{ discussion.type.name }})
</h2>
{% ifequal user_permission_type 1 %}
	<form action="/discussion-delete/{{discussion.pk}}/" method="post">
        <input type="image" onclick="if(confirm('Are you sure you want to delete this discussion?')) {this.form.submit();} else { return false; }" src="/static/img/icons/delete.png">Delete discussion</input>
    </form>
{% endifequal %}


<p>
	{{ discussion.description }}
</p>

<div id="canvasContainer"></div>

{% block story_input %}
{% if user_in_group %}
<form name="story_create" class="hidden" method="POST" action="/discussions/add_story/">
    <input type="hidden" name="discussion" value="{{ discussion.id }}" />
	<input type="hidden" name="story-class" value="1" />
	<input type="hidden" name="speech_act" value="1" />
	<fieldset class="story_input-title">
		<legend>{% trans 'Title:' %}</legend>
		<input type="text" name="title" class="is_value"/>
		<span class="clean_title hidden"></span>
	</fieldset>
</form>
<form name="opinion_create" class="hidden" method="POST" action="/discussions/add_story/">
    <input type="hidden" name="discussion" value="{{ discussion.id }}" />
    <input type="hidden" name="story-class" value="2" />
	<input type="hidden" name="parent_story" value="" />
	<input type="hidden" name="parent_class" value="1" />
	<div id="story_input-types">
		<fieldset>
			<legend>{% trans 'Speech act:' %}</legend>
			{% for sa in opinion_types %}
			<input type="radio" name="speech_act" value="{{ sa.pk }}" id="opinion_{{ sa.name }}" user_name="{{ user.username }}" {% if forloop.first %} checked="checked" {% endif %} /><label for="opinion_{{ sa.name }}"> {{ sa.name }}</label><br/>
            {% endfor %}
		</fieldset>
	</div>
    <fieldset class="story_input-title">
		<legend>{% trans 'Title:' %}</legend>
		<input type="text" name="title" class="is_value"/>
		<span class="clean_title hidden"></span>
	</fieldset>
</form>
<form name="relation_create" class="hidden" method="POST" action="/discussions/add_story/">
    <input type="hidden" name="discussion" value="{{ discussion.id }}" />
    <input type="hidden" name="story-class" value="3" />
    <input type="hidden" name="from_story" value="" />
    <input type="hidden" name="speech_act" value="{% for sa in speech_acts %}{% ifequal sa.story_type 3 %}{{ sa.pk }}{% endifequal %}{% endfor %}" />
	<div id="story_input-stories">
		<fieldset>
			<legend>{% trans 'To story:' %}</legend>
			<select name="to_story">

			</select>
		</fieldset>
	</div>
	<fieldset class="story_input-title">
		<legend>{% trans 'Title:' %}</legend>
		<input type="text" name="title" class="is_value"/>
		<span class="clean_title hidden"></span>
	</fieldset>
</form>
{% endif %}
{% endblock %}
{% endblock content %}